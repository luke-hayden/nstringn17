---
title: "Reliable rejuvenation signal?"
author: "Luke Hayden"
output: html_document
---

#Setup
###Packages
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
#source("https://bioconductor.org/biocLite.R")
#biocLite("DESeq2")
#source("https://bioconductor.org/biocLite.R")
#biocLite("DESeq2")

library(ggplot2)
library(rmarkdown)
library(gplots)
library(RColorBrewer)
library(reshape2)
library(scales)
library(ggbiplot)
library(devtools)
library(NanoStringNorm)
library(gtools)
library(Rmisc)
library(dplyr)
library(tidyr)
library(caret)
library(e1071)
library(caTools)

```

###Data Import

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, results="hide"}
setwd("~/Documents/nstringnov17")
load(file="nov17main_data.rdata")
```

#What is our best set of markers?


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

md <- t(subset(t(ctg1to9), sampleinfo$sex == "F"& sampleinfo$qual == "ok"& sampleinfo$exp == "OvY" & sampleinfo$ctg>2& sampleinfo$type %in% c("O", "Y")& sampleinfo$size== "P" ))

si <- subset(sampleinfo, sampleinfo$sample %in% colnames(md))
old <- t(subset(t(md), si$age == "O"))
young <- t(subset(t(md), si$age == "Y"))
regen <- t(subset(t(ctg1to9), sampleinfo$type == "OR" & sampleinfo$qual == "ok"))





nmd <- as.data.frame(md/rowMeans(md))
nmd$name <- rownames(nmd)
nmd$sname <- substr(nmd$name, 1,2)

oy <- cbind(old, young)
t.result <-  apply(oy, 1, function (x) t.test(x[1:ncol(old)],x[ncol(old)+1: ncol(oy)]))


nmd$p_value <- unlist(lapply(t.result, function(x) x$p.value))

nmd <- left_join(nmd, geneinf, by="name")



nmd$YvOl2fc <- foldchange2logratio(foldchange(rowMeans(young), rowMeans(old)))
nmd$ROvOl2fc <- foldchange2logratio(foldchange(rowMeans(regen), rowMeans(old)))

nmd$chosen <- nmd$p_value < 0.05 & sign(nmd$transl2fc) == sign(nmd$YvOl2fc)


ggplot(nmd, aes(y=p_value, x=abs(YvOl2fc), colour=in61,shape=in61,  fill=chosen))  +
  scale_shape_manual(values=c(21,22))+
  geom_point()+ 
  theme_minimal()+
  scale_fill_manual(values=c("cornflower blue", "forestgreen"), name="Amongst new chosen set") +
  scale_colour_manual(values=c("red3", "black"))+
  xlab("Absolute Young vs Old Log2Foldchange") +
  ylab("Old vs young p-value")+
  ggtitle(paste(sum(nmd$chosen), " markers: new optimised set"))+
    geom_hline(linetype=2, yintercept = 0.05)
  



```

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
nmd$sname <- factor(nmd$sname, levels=nmd$sname[order(nmd$p_value)])

mnmd <- gather(nmd, key=sample, value=normexp, O2a:LFPC)
mnmd$age <- ifelse(mnmd$sample %in% colnames(young), "young", "old")


ggplot(mnmd, aes(x= sname, y=normexp, colour=age)) +
  theme_minimal()+
  geom_point(size=3, shape=95)+
 stat_summary()+
  scale_y_continuous(trans="log2")+
  facet_grid(~dir, space="free",scales="free" )+
#  geom_boxplot(outlier.shape = NA)+
  scale_colour_manual(values=c("cornflower blue", "red3"))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=4))+
  geom_text(colour="black",label="*", data=nmd,inherit.aes=FALSE,  aes(alpha=chosen, x=sname, y=8))+
  scale_alpha_manual(values=c(0,1))


```

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


ggplot(mnmd, aes(x= sname, y=normexp, colour=age)) +
  theme_minimal()+
  geom_boxplot(outlier.shape = NA)+
  scale_y_continuous(trans="log2")+
  facet_grid(~dir, space="free",scales="free" )+
#  geom_boxplot(outlier.shape = NA)+
  scale_colour_manual(values=c("cornflower blue", "red3"))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=4))+
  geom_text(colour="black",label="*", data=nmd,inherit.aes=FALSE,  aes(alpha=chosen, x=sname, y=8))


```

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
minf <- nmd[,colnames(nmd) %in% c("name"   ,   "sname"    , "p_value",   "transl2fc", "dir"  ,     "in61"    ,  "YvOl2fc"  , "ROvOl2fc",  "chosen" )]





```


#Compare old vs new marker set

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N"

bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in% geneinf$name[geneinf$in61==T])
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups


a=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+ggtitle("PCA of Old vs Young (females): 61 chosen markers")+
    theme_minimal() +
  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))



bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in% nmd$name[nmd$chosen==TRUE])
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

b=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+ggtitle(paste("PCA of Old vs Young (females):", nrow(bcmin) ," newly chosen markers"))+
    theme_minimal() +
  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))


multiplot(a,b, cols=2)


```

Without Nikos' samples:

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N" &sampleinfo$prep == "Luke"

bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in% geneinf$name[geneinf$in61==T])
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups


a=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+ggtitle("PCA of Old vs Young (females): 61 chosen markers")+
    theme_minimal() +
  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))



bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in% nmd$name[nmd$chosen==TRUE])
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

b=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+ggtitle(paste("PCA of Old vs Young (females):", nrow(bcmin) ,"newly chosen markers"))+
    theme_minimal() +
  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))


multiplot(a,b, cols=2)


```


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
gnmd <- subset(nmd, nmd$chosen== TRUE)

ggplot(data=nmd, aes(x=YvOl2fc, y=ROvOl2fc, label=sname, colour=chosen))+
  geom_hline(yintercept=0, colour="black")+
  geom_vline(xintercept=0, colour="black")+
  theme_minimal()+
  xlim(-5,+5)+
  ylim(-5,5)+
 scale_colour_manual(values= c("grey", "forest green"), name="Marker", labels=c("other","chosen"))+
  xlab("Young vs Old Log2 Fold Change") +
  ylab("Regenerated vs Old Log2 Fold Change")+
#  geom_rect(inherit.aes=FALSE, xmin=-10, ymin=-10, xmax=0, ymax=0, fill="yellow", alpha=0.004)+
#  geom_rect(inherit.aes=FALSE,xmin=0, ymin=0, xmax=10, ymax=10, fill="yellow", alpha=0.004)+
  geom_point( size=1.5)+


  geom_abline(inherit.aes=FALSE, intercept=0, slope=1, linetype=2)+
  theme(    plot.background = element_rect(fill = "transparent",colour = "transparent") )+
  coord_fixed(ratio=1)
  

```

#Logistic regression model to separate old from young

First: use all markers as predictors of status in old vs young

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

dmat<- as.data.frame(subset(t(ctg1to9), sampleinfo$sex == "F"& sampleinfo$qual == "ok"& sampleinfo$exp == "OvY" & sampleinfo$ctg>2& sampleinfo$type %in% c("O", "Y")& sampleinfo$size== "P" ))


dmat$age <- rownames(dmat) %in% colnames(young)

#logmod <- glm(age~., dmat, family='binomial')
logmod <- lm(age~., dmat,method="binomial" )

pred <- predict(logmod, type='response')

predclass <- ifelse(pred> 0.5, T, F)

confusionMatrix(predclass, dmat$age)

colAUC(pred, dmat$age, plotROC=T)


(modcoefs <- data.frame(logmodcoef=coef(logmod), name=names(coef(logmod))))


minf2 <- left_join(minf, modcoefs, by="name")

```


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

dmat$age <- ifelse(rownames(dmat) %in% colnames(young), "young", "old")

myControl <- trainControl(
  method = "cv",
  number = 4,
  summaryFunction = twoClassSummary,
  classProbs = TRUE, # IMPORTANT!
  verboseIter = TRUE
)

(logmodcv <- train(age~.,dmat,method='glm', trControl=myControl ))

#ggplot( cbind(dmat, pred), aes(x=age, y=pred))+geom_boxplot()

predcv <- predict(logmodcv)




(modcoefs <- data.frame(logmodcoef=coef(logmodcv$finalModel), name=names(coef(logmodcv$finalModel))))


minf2 <- left_join(minf, modcoefs, by="name")

```

#Nikos plot
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
md <- ctg1to9
old <- t(subset(t(md), sampleinfo$type =="O" &  sampleinfo$sex == "F" & sampleinfo$qual =="ok" &sampleinfo$ctg %in% c(3,4,5,7)))

young <- t(subset(t(md), sampleinfo$type =="Y" & sampleinfo$sex== "F" & sampleinfo$qual =="ok"&sampleinfo$ctg %in% c(3,4,5,7)))

regen <- t(subset(t(md), sampleinfo$type =="OR" & sampleinfo$qual =="ok" &sampleinfo$ctg>2))

nmd <- md/rowMeans(cbind(young, old))

nik<- data.frame(
  fullname= rownames(md), 
  sname = substr(rownames(md),1,2), 
  YvOl2fc= foldchange2logratio(foldchange(rowMeans(young),            rowMeans(old))),
  ROvOl2fc= foldchange2logratio(foldchange(rowMeans(regen), rowMeans(old))),
  in61 =rownames(md) %in% gm$marker)

snik=subset(nik, nik$in61==TRUE)

ggplot(data=nik, aes(x=YvOl2fc, y=ROvOl2fc, label=sname, colour=in61))+
  geom_hline(yintercept=0, colour="black")+
  geom_vline(xintercept=0, colour="black")+
  theme_bw()+
  xlim(-6,+6)+
  ylim(-6,6)+
 scale_colour_manual(values= c("forest green", "cornflower blue"), name="Marker", labels=c("other","61 chosen"))+
  xlab("Young vs Old Log2 Fold Change") +
  ylab("Regenerated vs Old Log2 Fold Change")+
#  geom_rect(inherit.aes=FALSE, xmin=-10, ymin=-10, xmax=0, ymax=0, fill="yellow", alpha=0.004)+
#  geom_rect(inherit.aes=FALSE,xmin=0, ymin=0, xmax=10, ymax=10, fill="yellow", alpha=0.004)+
  geom_point( size=8, alpha=0.4)+
  geom_abline(inherit.aes=FALSE, intercept=0, slope=1, linetype=2)+
  theme(    plot.background = element_rect(fill = "transparent",colour = "transparent") )+
  geom_text()+
  coord_fixed(ratio=1)+
  facet_wrap(~in61)+
  theme(strip.text=element_blank())
  



ggsave(plot=a, height=7.5,width=15,dpi=200, device="png", filename=paste("nplot.png"), limitsize = FALSE,bg = "transparent")


```

#Variation due to Regeneration
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
md <- t(subset(t(ctg1to9), sampleinfo$sex == "F"& sampleinfo$qual == "ok"&  sampleinfo$ctg>2& sampleinfo$type %in% c("O", "Y", "OR") ))
si <- subset(sampleinfo, sampleinfo$sample %in% colnames(md))
nmd <- as.data.frame(md/rowMeans(md))
regonly <- t(subset(t(nmd), si$type == "OR"))
nmd$regstdev <- apply(regonly, 1,sd)
nmd <- subset(nmd, rownames(nmd)%in% gm$marker)
nmd$marker <- rownames(nmd)
nmd <- nmd[order(nmd$marker),]
gm <- gm[order(gm$marker),]
nmd$dir <- gm$dir[gm$dir != "housekeeping"]

nmd$smarker <- substr(nmd$marker,1,2)
nmd$smarker <- factor(nmd$smarker, levels=nmd$smarker[order(nmd$regstdev)])


mnmd <- melt(nmd, id.vars=c("marker", "dir", "regstdev", "smarker"))
mnmd$type <- "Y"
mnmd$type[mnmd$variable %in% si$sample[si$type== "OR"]] <- "OR"
mnmd$type[mnmd$variable %in% si$sample[si$type== "O"]] <- "O"


ggplot(mnmd, aes(x= smarker, y=value, colour=type)) +
  theme_bw()+
  scale_y_continuous(trans="log2")+
  facet_grid(~dir, space="free",scales="free" )+
  geom_boxplot(outlier.shape = NA)+
  scale_colour_manual(values=c("cornflower blue", "forest green", "red3" ))+ 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=6))
#  geom_text(aes(label=variable), size=1)


```

#Reliable rejuvenation?

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
md <- ctg1to9
old <- t(subset(t(md), sampleinfo$type =="O" &  sampleinfo$sex == "F" & sampleinfo$qual =="ok" &sampleinfo$ctg %in% c(3,4,5,7)))

young <- t(subset(t(md), sampleinfo$type =="Y" & sampleinfo$sex== "F" & sampleinfo$qual =="ok"&sampleinfo$ctg %in% c(3,4,5,7)))

regen <- t(subset(t(md), sampleinfo$type =="OR" & sampleinfo$qual =="ok" &sampleinfo$ctg>2))

oy <- cbind(old, young)

t.result <- apply(oy, 1, function (x)
t.test(x[1:ncol(old)],x[ncol(old)+1:ncol(oy)]))
ovy.p_value <- unlist(lapply(t.result, function(x) x$p.value))


oreg <- cbind(old, regen)

t.result <- apply(oreg, 1, function (x)
t.test(x[1:ncol(old)],x[ncol(old)+1:ncol(oreg)]))
ovreg.p_value <- unlist(lapply(t.result, function(x) x$p.value))

nold <- old/rowMeans(md)
nyoung <- young/rowMeans(md)
nregen <- regen/rowMeans(md)

nmd <- md/rowMeans(cbind(young, old))



nik<- data.frame(
  fullname= rownames(md), 
  sname = substr(rownames(md),1,2), 
  YvOl2fc= foldchange2logratio(foldchange(rowMeans(young),            rowMeans(old))),
  ROvOl2fc= foldchange2logratio(foldchange(rowMeans(regen), rowMeans(old))),
  in61 =rownames(md) %in% gm$marker, 
  ovypval = ovy.p_value, 
  ovrpval = ovreg.p_value,
  oldsd=  apply(nold, 1,sd),
  youngsd = apply(nyoung, 1,sd),
  regsd = apply(nregen, 1,sd))

nik$ovysig <- nik$ovypval <0.05
nik$ovrsig <- nik$ovrpval <0.1

ggplot(data=nik, aes(x=YvOl2fc, y=ROvOl2fc, label=sname, fill=regsd, shape=ovrsig))+
  geom_hline(yintercept=0, colour="black")+
  geom_vline(xintercept=0, colour="black")+
  theme_minimal()+
  xlim(-6,+6)+
  ylim(-6,6)+
  xlab("Young vs Old Log2 Fold Change") +
  ylab("Regenerated vs Old Log2 Fold Change")+
#  geom_rect(inherit.aes=FALSE, xmin=-10, ymin=-10, xmax=0, ymax=0, fill="yellow", alpha=0.004)+
#  geom_rect(inherit.aes=FALSE,xmin=0, ymin=0, xmax=10, ymax=10, fill="yellow", alpha=0.004)+
  geom_point( size=3)+
  scale_shape_manual(values=c(21,23), labels=c(">0.1", "<0.1"), breaks=c(FALSE, TRUE) ,name="RO vs O p-value" )+
  geom_abline(inherit.aes=FALSE, intercept=0, slope=1, linetype=2)+
  theme(    plot.background = element_rect(fill = "transparent",colour = "transparent") )+
  coord_fixed(ratio=1)+
scale_fill_gradient2(high="red3", mid="white", low="blue", midpoint=4, name="Stdev (regen)")+
  facet_wrap(~ovysig)


nik$good <- nik$ROvOl2fc/nik$YvOl2fc > 0.6 & nik$ovysig ==TRUE &nik$regsd <3
nik$reju <- " neither"
nik$reju[nik$ROvOl2fc/nik$YvOl2fc > 0.6 & nik$ovysig ==TRUE &nik$regsd <3] <- "rejuvenated"
nik$reju[nik$ROvOl2fc/nik$YvOl2fc < -0.6 & nik$ovysig ==TRUE &nik$regsd <3] <- "aged"

ggplot(data=nik, aes(x=YvOl2fc, y=ROvOl2fc, label=sname, fill=regsd,colour=reju, shape=ovrsig))+
  geom_hline(yintercept=0, colour="black")+
  geom_vline(xintercept=0, colour="black")+
  theme_minimal()+
  xlim(-6,+6)+
  ylim(-6,6)+
  xlab("Young vs Old Log2 Fold Change") +
  ylab("Regenerated vs Old Log2 Fold Change")+
#  geom_rect(inherit.aes=FALSE, xmin=-10, ymin=-10, xmax=0, ymax=0, fill="yellow", alpha=0.004)+
#  geom_rect(inherit.aes=FALSE,xmin=0, ymin=0, xmax=10, ymax=10, fill="yellow", alpha=0.004)+
  geom_point( size=3.5)+
  scale_shape_manual(values=c(21,23), labels=c(">0.1", "<0.1"), breaks=c(FALSE, TRUE) ,name="Regen vs Old \np-value" )+
  geom_abline(inherit.aes=FALSE, intercept=0, slope=1, linetype=2)+
  theme(    plot.background = element_rect(fill = "transparent",colour = "transparent") )+
  coord_fixed(ratio=1)+
scale_fill_gradient2(high="darkgoldenrod1", mid="white", low="blue", midpoint=2.5, name="Standard deviation \n amongst regenerated")+
  facet_wrap(~ovysig)+
  geom_text(size=1.7, aes(alpha=reju))+
  scale_colour_manual( values=c("red2",   "black", "dark green"), name="Rejuvenation")+
  scale_alpha_manual(values=c(1,0,1))




```


#Rejuventating Markers
Only those with:
Ratio of YvO l2fc / RO vs O l2fc > 0.6
Stdev between regenerated <3

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
md <- t(subset(t(ctg1to9), sampleinfo$sex == "F"& sampleinfo$qual == "ok"&  sampleinfo$ctg>2& sampleinfo$type %in% c("O", "Y", "OR") ))
si <- subset(sampleinfo, sampleinfo$sample %in% colnames(md))
nmd <- as.data.frame(md/rowMeans(md))
regonly <- t(subset(t(nmd), si$type == "OR"))
nmd$regstdev <- apply(regonly, 1,sd)

nmd$marker <- rownames(nmd)
nmd <- nmd[order(nmd$marker),]
codeset <- codeset[order(codeset$shortname),]
nmd$dir <- "upregulated with age"
nmd$dir[codeset$log2FoldChange > 0] <- "downregulated with age" 



nmd$smarker <- substr(nmd$marker,1,2)
nmd$smarker <- factor(nmd$smarker, levels=nmd$smarker[order(nmd$regstdev)])
nmd <- subset(nmd, nmd$marker %in% nik$fullname[nik$good ==T])

mnmd <- melt(nmd, id.vars=c("marker", "regstdev", "dir", "smarker"))
mnmd$type <- "Y"
mnmd$type[mnmd$variable %in% si$sample[si$type== "OR"]] <- "OR"
mnmd$type[mnmd$variable %in% si$sample[si$type== "O"]] <- "O"

mcodeset <- subset(codeset, codeset$Customer_Identifier %in% nmd$marker)

print(paste(mcodeset$shortname, ": " ,mcodeset$DrosoTopHit, sep=""))

print(paste(mcodeset$shortname, ": " ,mcodeset$TopHit, sep=""))

mnmd$topblast <- ""

for (i in 1:length(codeset$baseMean)){
  x = mnmd$marker == codeset$Customer_Identifier[i]
  mnmd$topblast[x] <- as.character(codeset$TopHit[i])
  mnmd$dtopblast[x] <- as.character(codeset$DrosoTopHit[i])
}



```



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

ggplot(mnmd, aes(x= smarker, y=value, fill=type)) +
  theme_minimal()+
  scale_y_continuous(trans="log2")+
  facet_grid(~dir, space="free",scales="free" )+
#  stat_summary()+
  geom_boxplot(outlier.shape = NA)+
#  geom_point(shape=21)+
  scale_fill_manual(values=c("cornflower blue", "forest green", "red3" ))+ 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=10))+
  xlab("Marker")+
  ylab("Expression level (normalised)")
  
#  geom_text(aes(label=variable), size=1)
mnmd$smarkerdir <- paste(substr(mnmd$dir,1,2), mnmd$smarker)
umnmd <- subset(mnmd, !duplicated(mnmd$marker))



#mcodeset$smarkerdir <- paste(substr(mcodeset$dir,1,2), mnmd$smarker)
  
  
ggplot(mnmd, aes(x= value, fill=type)) +

  theme_minimal()+
  scale_x_continuous(trans="log2", breaks=c(0.125,0.25,0.5,1,2,4), limits=c(0.125,4))+
  facet_wrap(~smarkerdir, ncol=3, scales="free_y")+
  geom_density(alpha=0.5)  +
  scale_fill_manual(values=c("cornflower blue", "forest green", "red3" ))+ 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=10))+
  xlab("Expression level (normalised)")+
  geom_text(data=umnmd, aes(x=0.2, y=0.6, label=dtopblast), size=2,inherit.aes = F)



```



