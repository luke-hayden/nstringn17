---
title: "NanoStringNov17"
author: "Luke Hayden"
date: "24 November 2017"
output: html_document
---

#Setup
###Packages
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
#source("https://bioconductor.org/biocLite.R")
#biocLite("DESeq2")
#source("https://bioconductor.org/biocLite.R")
#biocLite("DESeq2")

library(ggplot2)
library(DESeq2)
library(rmarkdown)
library(pracma)
library(gplots)
library(RColorBrewer)
library(reshape2)
library(scales)
library(ggbiplot)
library(gtools)
library(devtools)
library(NanoStringNorm)
library(ggthemes)
library(grid)
library(gridExtra)
library(sjstats)
library(matrixStats)
library(gbutils)
library(Rmisc)
```

###Data Import

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


gm <- read.csv("gmark.csv")

setwd("~/Documents/nstringnov17/ctg5and6")
ct5and6.raw <- read.markup.RCC()


setwd("~/Documents/nstringnov17/ctg5hi")
ct5and6hi.raw <- read.markup.RCC()


setwd("~/Documents/nstringnov17/ctg7and8")
ct7and8.raw <- read.markup.RCC()


setwd("~/Documents/nstringnov17/ctg7and8hi")
ct7and8hi.raw <- read.markup.RCC()

setwd("~/Documents/nstringnov17/ctg3and4")

ct3and4.raw <- read.markup.RCC()


setwd("~/Documents/nstringnov17/ctg1and2")

ct1and2.raw <- read.markup.RCC()


setwd("~/Documents/nstringnov17/ctg9")

ct9.raw <- read.markup.RCC()

````

###Normalisation

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, results="hide"}
codeset <- read.table("CodeSet.txt")
codeset$shortname <- substr(codeset$Customer_Identifier, 1,2)
Cht <- read.table("CodeSetCountdata.txt")

ctg5and6.norm <- NanoStringNorm(x = ct5and6.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg5and6.unnorm <- NanoStringNorm(x = ct5and6.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg5and6hi.norm <- NanoStringNorm(x = ct5and6hi.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg7and8.norm <- NanoStringNorm(x = ct7and8.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg7and8hi.norm <- NanoStringNorm(x = ct7and8hi.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg3and4.norm <- NanoStringNorm(x = ct3and4.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);


ctg1and2.norm <- NanoStringNorm(x = ct1and2.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg9.norm <- NanoStringNorm(x = ct9.raw, anno = NA, CodeCount ='sum', Background ="mean", SampleContent ='housekeeping.sum', round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

````

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, results="hide"}

ctg5and6.unnorm <- NanoStringNorm(x = ct5and6.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg5and6hi.unnorm <- NanoStringNorm(x = ct5and6hi.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg7and8.unnorm <- NanoStringNorm(x = ct7and8.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg7and8hi.unnorm <- NanoStringNorm(x = ct7and8hi.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg3and4.unnorm <- NanoStringNorm(x = ct3and4.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);


ctg1and2.unnorm <- NanoStringNorm(x = ct1and2.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

ctg9.unnorm <- NanoStringNorm(x = ct9.raw, anno = NA, CodeCount ='sum', Background ="mean",OtherNorm = "none", round.values = FALSE, take.log = FALSE,return.matrix.of.endogenous.probes = TRUE);

````

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, results="hide"}


colnames(ctg1and2.norm) <- c("C200", "C100", "C50", "C25", "C12", "C6", "CIA", "CIB", "FYA", "FOA", "MYA", "MOA","FYB",	"FOB",	"MYB",	"MOB",	"MOIA",	"MOIB","MOIC",	"MOID",	"CS1X",	"CS0.5X",	"CS0.25XA",	"CS0.25XB")
colnames(ctg1and2.unnorm) <- colnames(ctg1and2.norm) 

colnames(ctg3and4.norm) <- c("O1a", "O2a", "Y1a", "Y2a", "OR1a", "OR2a", "YR1a", "YR2a", "FY5a", "FY6a", "FO5a", "FO7a", "O1b", "O2b", "Y1b", "Y2b", "OR1b", "OR2b", "YR1b", "YR2b", "FY7", "FY8", "FO8", "FO9")
colnames(ctg3and4.unnorm) <- colnames(ctg3and4.norm) 

colnames(ctg5and6.norm) <- c("SFPA", "SFPB", "LFPA", "LFPB", "SMPA", "SMPB", "LMPA", "LMPB", "LMIA", "LMIB", "LMIC", "LMID", "Abef", "Aun", "Areg", "Bbef", "Bun", "Breg", "Cbef", "Cun", "Creg", "Dbef", "Dun", "Dreg")
colnames(ctg5and6.unnorm) <- colnames(ctg5and6.norm) 

colnames(ctg5and6hi.norm) <-  c("SFPA", "SFPB", "LFPA", "LFPB", "SMPA", "SMPB", "LMPA", "LMPB", "LMIA", "LMIB", "LMIC", "LMID", "Abef", "Aun", "Areg", "Bbef", "Bun", "Breg", "Cbef", "Cun", "Creg", "Dbef", "Dun", "Dreg")
colnames(ctg5and6hi.unnorm) <- colnames(ctg5and6hi.norm) 

colnames(ctg7and8.norm) <- c("SFPC","SFPD", "LFPC", "LFPD", "SMPC", "SMPD","LMPC", "LMPD", "0mPA", "0mPB", "10mPA", "20mPA", "Ebef", "Eun", "Ereg", "Fbef", "Fun", "Freg", "Gbef", "Gun", "Greg", "LFIA", "LFIB", "20mPB")
colnames(ctg7and8.unnorm) <- colnames(ctg7and8.norm) 

colnames(ctg7and8hi.norm) <-c("SFPC","SFPD", "LFPC", "LFPD", "SMPC", "SMPD","LMPC", "LMPD", "0mPA", "0mPB", "10mPA", "20mPA", "Ebef", "Eun", "Ereg", "Fbef", "Fun", "Freg", "Gbef", "Gun", "Greg", "LFIA", "LFIB", "20mPB")
colnames(ctg7and8hi.unnorm) <- colnames(ctg7and8hi.norm) 

colnames(ctg9.norm) <- c("LFIC", "LFID", "OmID", "10mIA", "n", "20mIC", "Ibef", "Iun", "Ireg", "Kbef", "Kun", "Kreg")
colnames(ctg9.unnorm) <- colnames(ctg9.norm) 

ctg3to9 <- cbind(ctg3and4.norm, ctg5and6hi.norm, ctg7and8hi.norm, ctg9.norm)

ctg1to9 <- cbind(ctg1and2.norm,ctg3and4.norm, ctg5and6hi.norm, ctg7and8hi.norm, ctg9.norm)


sampleinfo <- data.frame(

sample=colnames(ctg1to9), 
                         
sex=c(rep("M", 8), rep(c("F", "F", "M", "M"), 2), rep("M", 8), rep("F", 28), rep("M", 8), rep("F", 16), rep("M", 4), rep("F", 28)), 

age=c(rep("O",8), rep(c("Y","O","Y","O"),2),rep("O",8),  rep(c("O", "O", "Y", "Y", "O", "O", "Y", "Y","Y", "Y", "O", "O"), 2), c("Y", "Y", "O", "O", "Y", "Y", "O", "O", "O", "O", "O", "O", rep("O", 12)), c("Y", "Y", "O", "O", "Y", "Y", "O", "O", "N", "N", "N", "N"), rep("O", 11), c("N", "O", "O",  "N", "N", "N", "N", "O", "O", "O", "O", "O", "O")), 

reg=c(rep("",24), rep(c(rep("", 4), rep("R", 4), rep("", 4)), 2), c(rep("", 12), rep(c("", "", "R"),4 )   ), c(rep("", 12), rep(c("", "", "R"),3 )   ), rep("",11 ), "R", "", "", "R") , 

ctg=c(rep("1", 12), rep("2", 12),rep("3", 12), rep("4", 12), rep("5", 12), rep("6", 12), rep("7", 12), rep("8", 12), rep("9", 12)),

size= c(rep("P",6), "I", "I", rep("P",8),rep("I",4), rep("I",4), rep("P", 32), rep("I", 4), rep("P",27), rep("I", 8), "P", rep("I", 4), rep("I", 8)), 

moult = c(rep("", 80), 0,0,10,20,rep("", 11),20,"","", 0,10,"", 20,rep("", 6) )

)

sampleinfo$type <- paste(sampleinfo$age, sampleinfo$reg, sep="")
sampleinfo$qual <- "ok"
sampleinfo$qual[c(25 , 31 , 32 , 49,  54 , 67  ,76,  90, 101, 104, 107)] <- "bad"
#sampleinfo$moult <- c(rep(NA, 80), 0,0,10,20,rep(NA, 11),20,NA,NA, 0,10,NA, 20,rep(NA, 6) )

#print("Samples as follows (all experiments)")
#print(paste("males: " sum()))

```

#Samples
##New samples:
59 samples in total

Including: 

Old and young male and female pools

Old male and female individuals

Females at 0, 10 and 20 days after moulting, pools and individuals

Regeneration experiment sets: each pool individual has three samples taken:

Left T4 & T5 limbs at t0 (bef)

Left T4 & T5 limbs at t30, after regeneration (reg)

Right T4 &T5 limbs at t30 (un)

##Sample Quality
Quality is somewhat variable, with some samples, especially those with small amounts of RNA giving poor results. 

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, results="hide"}

mc36 <- melt(ctg3to9)
mc36$exp <- mc36$value > 1
mc36$isg <- mc36$Var1 %in% gm$marker
mc36$qual <- mc36$Var2 %in% sampleinfo$sample[sampleinfo$qual == "ok"]
#ggplot(mc36, aes(y=value, x=Var1, colour=qual)) +    theme_bw() +  geom_point(alpha=0.3) +  facet_wrap(~Var2) +  scale_y_log10() +  scale_colour_manual(values=c("red3", "dark blue")) +  theme(axis.text.x = element_blank())



```
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, results="hide"}

mc <- melt(ctg1to9)
mc$exp <- mc$value > 1
mc$qual <- mc$Var2 %in% sampleinfo$sample[sampleinfo$qual == "ok"]
#ggplot(mc, aes(y=value, x=Var1, colour=qual)) +  theme_bw() +  geom_point(alpha=0.3) +  facet_wrap(~Var2, ncol=12) +  scale_y_log10() +  scale_colour_manual(values=c("red3", "dark blue")) +  theme(axis.text.x = element_blank())

#ggplot(mc, aes(y=value, x=Var2, colour=qual)) +  theme_bw() +  geom_point(alpha=0.1) +  scale_y_log10() +  scale_colour_manual(values=c("red3", "dark blue")) +  theme(axis.text.x = element_text(angle = 80, hjust =1, size=7))



```


#Is the age signal retained?



##Females only
Can we replicate the previous result?
(Two low quality samples removed)

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N"


bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)


tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

a= ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+ggtitle("PCA of O vs Y (females): all 195 markers")+
    theme_bw() +
  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))


log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N"


bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in% gm$marker)
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

b= ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+ggtitle("PCA of O vs Y (females): 61 chosen markers")+
    theme_bw() +
  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))

multiplot(a,b, cols=2)
```

Yes! Our new samples cluster correctly with their age groups. 

And if we add the males and repeat the PCA:

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

log <- sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == ""& sampleinfo$age != "N"


bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(paste(sampleinfo$type, sampleinfo$sex), log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in% gm$marker)
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups) + theme_bw() +ggtitle("PCA of O vs Y: 61 chosen markers")+ scale_colour_manual(values=c("cornflower blue","dark blue",  "red3", "orangered"))
```

No good! The same set of markers doesn't function to separate old and young in males as it does in females. 

##Males only
Let's try to find an aging signature amongst the males. 
Using successive log2 old vs young foldchange cut-offs doesn't work, but we can try using our successive t-test p-value cut-off approach. 

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

log <- sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N"

oldm <- ctg1to9[, sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age == "O"]

youm <- ctg1to9[, sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age == "Y"]

bcmin.l2fc <- foldchange2logratio(foldchange(rowMeans(oldm), rowMeans(youm)))
bcmin.lscore <- order(bcmin.l2fc)

bcmin.samedir <- sign(bcmin.l2fc) == sign(codeset$log2FoldChange)

bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)

bcmin.num <- 160

bcmin <- subset(bcmin, bcmin.lscore < bcmin.num & bcmin.samedir ==TRUE)

tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

#ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+  theme_bw() +  ggtitle(paste("PCA of O vs Y: , ", nrow(bcmin), " markers"))+   scale_colour_manual(values=c("cornflower blue", "red3", "green"))




bcmin.num <- 100

bcmin <- ctg1to9[,log== TRUE]
bcmin <- subset(bcmin, bcmin.lscore < bcmin.num & bcmin.samedir ==TRUE)

tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

#ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+  theme_bw() +  ggtitle(paste("PCA of O vs Y: , ", nrow(bcmin), " markers"))+   scale_colour_manual(values=c("cornflower blue", "red3"))



bcmin.num <- 50

bcmin <- ctg1to9[,log== TRUE]
bcmin <- subset(bcmin, bcmin.lscore < bcmin.num & bcmin.samedir ==TRUE)

tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

#ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+  theme_bw() +  ggtitle(paste("PCA of O vs Y: , ", nrow(bcmin), " markers"))+   scale_colour_manual(values=c("cornflower blue", "red3"))

bcmin.num <- 25

bcmin <- ctg1to9[,log== TRUE]
bcmin <- subset(bcmin, bcmin.lscore < bcmin.num & bcmin.samedir ==TRUE)

tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

#ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+  theme_bw() +  ggtitle(paste("PCA of O vs Y: , ", nrow(bcmin), " markers"))+   scale_colour_manual(values=c("cornflower blue", "red3"))




```


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

log <- sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N"

o <- ctg1to9[, sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age == "O"]

y <- ctg1to9[, sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age == "Y"]

yo <- cbind(youm, oldm)

t.result <- apply(yo, 1, function (x) t.test(x[1:ncol(y)],x[ncol(y)+1:ncol(yo)]))
bcmin.p_value <- unlist(lapply(t.result, function(x) x$p.value))

bcmin.samedir <- sign(bcmin.l2fc) == sign(codeset$log2FoldChange)

bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)

bcmin.num <- 0.5

bcmin <- subset(bcmin, bcmin.p_value < bcmin.num & bcmin.samedir ==TRUE)

tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

a=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+  theme_bw() +
  ggtitle(paste("PCA of O vs Y: , ", nrow(bcmin), " markers (pval < ,", bcmin.num, ")" ))+ 
  scale_colour_manual(values=c("cornflower blue", "red3"))+
  theme(plot.title=element_text(size=8,face="bold"))+
  theme(axis.title=element_text(size=6))

bcmin.num <- 0.2

bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, bcmin.p_value < bcmin.num & bcmin.samedir ==TRUE)

tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

b=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+  theme_bw() +
  ggtitle(paste("PCA of O vs Y: , ", nrow(bcmin), " markers (pval < ,", bcmin.num, ")" ))+ 
  scale_colour_manual(values=c("cornflower blue", "red3"))+
  theme(plot.title=element_text(size=8,face="bold"))+
  theme(axis.title=element_text(size=6))
  
  
bcmin.num <- 0.1

bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, bcmin.p_value < bcmin.num & bcmin.samedir ==TRUE)

tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

c=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+  theme_bw() +
  ggtitle(paste("PCA of O vs Y: , ", nrow(bcmin), " markers (pval < ,", bcmin.num, ")" ))+ 
  scale_colour_manual(values=c("cornflower blue", "red3"))+
  theme(plot.title=element_text(size=8,face="bold"))+
  theme(axis.title=element_text(size=6))

bcmin.num <- 0.05

bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, bcmin.p_value < bcmin.num & bcmin.samedir ==TRUE)

tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

d=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+  theme_bw() +
  ggtitle(paste("PCA of O vs Y: , ", nrow(bcmin), " markers (pval < ,", bcmin.num, ")" ))+ 
  scale_colour_manual(values=c("cornflower blue", "red3"))+
  theme(plot.title=element_text(size=8,face="bold"))+
  theme(axis.title=element_text(size=6))

multiplot(a,b,c,d, cols=2)



```

So we also have an aging signal for the males, looks best @ pval<0.1 (10 markers). How does this compare to that for the females? Are these a subset of the markers that show a signal amongst females?


##Male vs Female Aging Signal



```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
#Males:
log <- sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N"
o <- ctg1to9[, sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age == "O"]
y <- ctg1to9[, sampleinfo$sex =="M" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age == "Y"]
yo <- cbind(youm, oldm)

t.result <- apply(yo, 1, function (x) t.test(x[1:ncol(y)],x[ncol(y)+1:ncol(yo)]))
males.p_value <- unlist(lapply(t.result, function(x) x$p.value))

#Females
log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N"
o <- ctg1to9[, sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age == "O"]
y <- ctg1to9[, sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age == "Y"]
yo <- cbind(y, o)

t.result <- apply(yo, 1, function (x) t.test(x[1:ncol(y)],x[ncol(y)+1:ncol(yo)]))
females.p_value <- unlist(lapply(t.result, function(x) x$p.value))

msum <- data.frame(mpval=males.p_value, fpval=females.p_value, marker=substr(rownames(ctg1to9),1,2), isg <- rownames(ctg1to9) %in% gm$marker)
msum$msig <- msum$mpval <0.05
msum$fsig <- msum$fpval <0.05

ggplot(msum, aes(x=mpval, y=fpval, colour=isg, label=marker)) +
  geom_text(size=3) +
  theme_bw() +
  geom_hline(yintercept=0.05, colour = "black", linetype=2) +
  geom_vline(xintercept=0.05, colour = "black", linetype=2) +
  scale_colour_manual(values=c("dark blue" , "chocolate1"), name="Marker in subset of 61?") +
  ylab("Female Old vs young p-value")+
  xlab("Male Old vs young p-value") +
  ggtitle("Marker old vs young p-value results in males vs females")




```

So males don't show the same aging signature as seen amongst the females. Why is this?


#Age signal by marker
##Females

Let's look at our female aging signal in more detail. 

We can also examine this aging signal on a marker by marker basis. Using our 61 chosen markers:

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
an <- ctg1to9
an <- subset(an, rownames(an) %in% gm$marker)
log <- sampleinfo$sex =="F" &  sampleinfo$qual == "ok" & sampleinfo$reg != "R"& sampleinfo$age != "N" & sampleinfo$ctg %in% c("3","4","5","6","7","8","9")
anf <- an[,log==TRUE]

anf <- anf/rowMeans(anf)

sif <- subset(sampleinfo, log)
colnames(anf) <- paste( sif$type, colnames(anf))
#anf <- rbind(anf, t(sif))
manf <- melt(anf)

manf$type <- substr(manf$Var2,1,2)
manf$mk <- substr(manf$Var1, 1,2)
manf$dir <- "upregulated with age"
manf$dir[manf$Var1 %in% gm$marker[gm$dir =="downregulated with age"]] <- "downregulated with age"
manf$dm <- paste(substr(manf$dir, 1,1), manf$mk)

manf$mk <- factor(manf$mk, levels=manf$mk[order(manf$dir)])



ggplot(manf, aes(x=mk, y=value, colour=type)) +
  geom_point(shape=95, size=4)  +
  theme_bw() +
  scale_color_manual(values=c("cornflower blue", "red3"), name= "Age") +
  theme(axis.text.x = element_text(angle = 60, hjust =1, size=7))+
  xlab("Marker") +
  ylab("Expression level (Normalised to mean)") +
  scale_y_continuous(trans='log2', breaks=c(0,0.062,0.125,0.25,0.5,1,2,4))+
  stat_summary(size=0.1)+
  ggtitle("Aging signal per marker (61 markers)") +
  facet_wrap(~dir, ncol=1, scales="free_x")


ggplot(manf, aes(x=mk, y=value, colour=type, fill=dir)) +
  geom_boxplot(outlier.alpha = 0)+
  theme_bw() +
#  scale_y_continuous(trans='log2', breaks=c(0,0.062,0.125,0.25,0.5,1,2,4))+
  geom_hline(yintercept=1, colour = "black", linetype=2) +
  scale_fill_manual(values=c("white", "dark grey"))  +
  scale_color_manual(values=c("cornflower blue", "red3")) +
  theme(axis.text.x = element_text(angle = 60, hjust =0.5, size=7)) +
  facet_wrap(~dir, ncol=1, scales="free_x") +
  xlab("Marker") +
  ylab("Expression level (Normalised to mean)") +
  ylim(c(0,6))+
  scale_y_continuous(trans='log2', breaks=c(0,0.062,0.125,0.25,0.5,1,2,4)) +
  ggtitle("Aging signal per marker (61 markers)")

```

In our complete marker set:

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
an <- ctg1to9

log <- sampleinfo$sex =="F" &  sampleinfo$qual == "ok" & sampleinfo$reg != "R"& sampleinfo$age != "N"& sampleinfo$ctg %in% c("3","4","5","6","7","8","9")
anf <- an[,log==TRUE]

sif <- subset(sampleinfo, log)

o <- anf[,sif$age == "O" & sif$sex == "F"]
y <- anf[,sif$age == "Y" & sif$sex == "F"]

yo <- as.data.frame(cbind(y,o))

anf <- as.data.frame(anf/rowMeans(anf))
t.result <- apply(yo, 1, function (x) t.test(x[1:ncol(y)],x[ncol(y)+1:ncol(yo)]))
anf$p_value <- unlist(lapply(t.result, function(x) x$p.value))
anf$t_stat <- unlist(lapply(t.result, function(x) x$statistic))
anf$marker <- rownames(anf)
anf$isg <- "not in chosen 61"
anf$isg[anf$marker %in% gm$marker] <- "chosen markers"



#colnames(anf) <- paste( sif$type, colnames(anf))
#anf <- rbind(anf, t(sif))
manf <- melt(anf, id.vars=c("p_value", "marker", "t_stat", "isg"))

manf$type <- "Old"
manf$type[manf$variable %in% sif$sample[sif$age == "Y"]] <- "Young"
manf$mk <- substr(manf$marker, 1,2)
manf$dir <- "upregulated with age"
manf$dir[manf$marker %in% codeset$Customer_Identifier[codeset$log2FoldChange >0]] <- "downregulated with age"
manf$dm <- paste(substr(manf$dir, 1,1), manf$mk)

ggplot(manf, aes(x=mk, y=value, colour=type, fill=dir)) +
  theme_bw()+
  geom_boxplot(outlier.alpha = 0)+
  scale_y_continuous(trans='log2', breaks=c(0,0.062,0.125,0.25,0.5,1,2,4))+
  geom_hline(yintercept=1, colour = "black", linetype=2) +
  scale_fill_manual(values=c("white", "dark grey"))  +
  scale_color_manual(values=c("cornflower blue", "red3")) +
  theme(axis.text.x = element_text(angle = 60, hjust =0.5, size=7)) +
  facet_wrap(isg~dir, ncol=1, scales="free_x", strip.position="left") +
  xlab("Marker") +
  ylab("Expression level (Normalised to mean)")+
  ggtitle("Old vs Young in females, both chosen and other markers") +
  theme(strip.text = element_text(size=6))
```

A strong age signal is present, but there is still quite a lot of noise present.  



##Males on a per marker basis


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
an <- ctg1to9

log <- sampleinfo$sex =="M" &  sampleinfo$qual == "ok" & sampleinfo$reg != "R"& sampleinfo$age != "N"& sampleinfo$ctg %in% c("3","4","5","6","7","8", "9")
anf <- an[,log==TRUE]

sif <- subset(sampleinfo, log)

o <- anf[,sif$age == "O" & sif$sex == "M"]
y <- anf[,sif$age == "Y" & sif$sex == "M"]

yo <- as.data.frame(cbind(y,o))

anf <- as.data.frame(anf/rowMeans(anf))
t.result <- apply(yo, 1, function (x) t.test(x[1:ncol(y)],x[ncol(y)+1:ncol(yo)]))
anf$p_value <- unlist(lapply(t.result, function(x) x$p.value))
anf$t_stat <- unlist(lapply(t.result, function(x) x$statistic))
anf$marker <- rownames(anf)
anf$isg <- "p-value >0.1"
anf$isg[anf$p_value<0.1] <- "p-value < 0.1"



#colnames(anf) <- paste( sif$type, colnames(anf))
#anf <- rbind(anf, t(sif))
manf <- melt(anf, id.vars=c("p_value", "marker", "t_stat", "isg"))

manf$type <- "Old"
manf$type[manf$variable %in% sif$sample[sif$age == "Y"]] <- "Young"
manf$mk <- substr(manf$marker, 1,2)
manf$dir <- "upregulated with age"
manf$dir[manf$marker %in% codeset$Customer_Identifier[codeset$log2FoldChange >0]] <- "downregulated with age"
manf$dm <- paste(substr(manf$dir, 1,1), manf$mk)

ggplot(manf, aes(x=mk, y=value, colour=type, fill=dir)) +
  theme_bw() +
  geom_boxplot(outlier.alpha = 0)+
  scale_y_continuous(trans='log2', breaks=c(0,0.062,0.125,0.25,0.5,1,2,4))+
  geom_hline(yintercept=1, colour = "black", linetype=2) +
  scale_fill_manual(values=c("white", "dark grey"))  +
  scale_color_manual(values=c("cornflower blue", "red3")) +
  theme(axis.text.x = element_text(angle = 60, hjust =0.5, size=7)) +
  facet_wrap(isg~dir, ncol=1, scales="free_x", strip.position="left") +
  xlab("Marker") +
  ylab("Expression level (Normalised to mean)")+
  ggtitle("Old vs Young in males, all markers")+
  theme(strip.text = element_text(size=6))
```

So we do have an aging signal in males, albeit a weaker one, present in fewer markers. 

##Variation in old vs young

In the above graphs, the old seem more variable, lets test this. Is it just a perception due to the log scale on the graphs above?


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
an <- ctg1to9

log <- sampleinfo$sex =="F" &  sampleinfo$qual == "ok" & sampleinfo$reg != "R"& sampleinfo$age != "N" & sampleinfo$size == "P" & sampleinfo$ctg %in% c("3","4","5","7")
anf <- an[,log==TRUE]
anf <- anf[,c(4:ncol(anf))]

sif <- subset(sampleinfo, sampleinfo$sample %in% colnames(anf))


anf <- anf/rowMeans(anf)

o <- anf[,sif$age == "O" & sif$sex == "F"]
y <- anf[,sif$age == "Y" & sif$sex == "F"]
anf <- as.data.frame(anf)
t.result <- apply(yo, 1, function (x) t.test(x[1:ncol(y)],x[ncol(y)+1:ncol(yo)]))
anf$p_value <- unlist(lapply(t.result, function(x) x$p.value))
anf$t_stat <- unlist(lapply(t.result, function(x) x$statistic))
anf$marker <- rownames(anf)
anf$isg <- "not in chosen 61"
anf$isg[anf$marker %in% gm$marker] <- "chosen markers"
mv <- data.frame(osd = rowSds(o), ysd = rowSds(y), ms = substr(anf$marker, 1,2), isg = anf$isg)
mv <- melt(mv, id.vars=c("ms", "isg"))

#ggplot(mv, aes(x=ms, colour=variable, y=value)) +  geom_point() +scale_color_manual(values=c("cornflower blue", "red3"))+ scale_y_continuous(trans='log2') +  facet_wrap(~isg)

ggplot(mv, aes(x=variable, y=value, colour=variable)) +
    theme_bw() +
  geom_boxplot(outlier.shape = NA)+  
  scale_color_manual(values=c("cornflower blue", "red3"), labels=c("Old", "Young")) +
  xlab("") +
  ylab("Standard deviation of normalised expression values")+
  ylim(c(0,2))

```

Yes!

#Effect of Regeneration

##Regen effect on PCA
Do we see a rejuvenation effect? Here we take our female old and young PCA, then project the regenerated samples (Nikos and mine) onto it. 

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}


log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == ""& sampleinfo$age != "N"


bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in% gm$marker)
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

rg <-ctg3to9[,c(5,6,17,18,37:42,44:48,61:69, 79:84)]
rg <- subset(rg, rownames(rg) %in% gm$marker)
rg.groups <- sampleinfo$type[sampleinfo$sample %in% colnames(rg)]

rg.sc <- scale(t(rg), center= bc.pca$center)
rg.pred <- rg.sc %*% bc.pca$rotation 


rgd.pca <- bc.pca
rgd.pca$x <- rbind(bc.pca$x, rg.pred)
                   
                   
rgd.groups <- append(bcmin.groups, rg.groups)                

ggbiplot(rgd.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(rgd.pca$x), groups=rgd.groups, varname.abbrev = TRUE)+   theme_bw() +theme(legend.direction = 'horizontal', legend.position = 'top')+ggtitle("PCA Old vs Young + regenerated projected")+ scale_colour_manual(values=c("cornflower blue", "forest green", "red3"))



````

Let's compare the regenerated samples with their controls


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
msi <- subset(sampleinfo, sampleinfo$sample %in% rownames(rgd.pca$x))
pcdf <- as.data.frame(rgd.pca$x)
pcdf <- data.frame(pc1val =pcdf$PC1, sample = rownames(rgd.pca$x) )
pcdf <-pcdf[26:51,]
pcdf$group <- substr(pcdf$sample,1,1)
pcdf$cond <- substr(pcdf$sample, 2, length(pcdf$sample))

ggplot(data=pcdf, aes(x=pc1val, y=sample, colour=cond, label=sample)) +
  theme_bw() +
  geom_text()+
  scale_colour_manual(values=c("cornflower blue" , "forest green", "dark blue"), name="Sample Type", labels=c("Before Amputation", "Regenerated","Unamputated"))+
  ylab("Condition") +
  xlab("PC1 value") +
  ggtitle("Effect per marker, per sample") 
  

```

We don't see an overall rejuvenating effect. Maybe examine this on a marker by marker basis?


##Regen effect on per marker basis

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
an <- ctg1to9
an <- subset(an, rownames(an) %in% gm$marker)
log <- sampleinfo$sex =="F" &  sampleinfo$qual == "ok" & sampleinfo$type != "YR"& sampleinfo$age != "N"& sampleinfo$ctg %in% c(3,4,5,6,7,8,9) 
anf <- an[,log==TRUE]
anf <- anf/rowMeans(anf)

sif <- subset(sampleinfo, log)
colnames(anf) <- paste( sif$type, colnames(anf))
#anf <- rbind(anf, t(sif))
manf <- melt(anf)

manf$type <- substr(manf$Var2,1,2)
manf$mk <- substr(manf$Var1, 1,2)
manf$dir <- "upregulated with age"
manf$dir[manf$Var1 %in% gm$marker[gm$dir =="downregulated with age"]] <- "downregulated with age"
manf$dm <- paste(substr(manf$dir, 1,1), manf$mk)

ggplot(manf, aes(x=dm, y=value, colour=type)) +
  theme_bw() +
  geom_point(shape=95, size=4)  +
  scale_color_manual(values=c("cornflower blue", "forest green",  "red3"), name= "Age") +
  theme(axis.text.x = element_text(angle = 60, hjust =1, size=7))+
  xlab("Marker") +
  ylab("Expression level (Normalised to mean)") +
  scale_y_continuous(trans='log2', breaks=c(0,0.062,0.125,0.25,0.5,1,2,4))


ggplot(manf, aes(x=mk, y=value, colour=type, fill=dir)) +
  theme_bw() +
  geom_boxplot(outlier.shape=NA)+
  scale_y_continuous(trans='log2', breaks=c(0,0.25,0.5,1,2,4))+
  geom_hline(yintercept=1, colour = "black", linetype=2) +
  scale_fill_manual(values=c("white", "dark grey"))  +
  scale_color_manual(values=c("cornflower blue", "forest green",  "red3")) +
  theme(axis.text.x = element_text(angle = 60, hjust =0.5, size=7)) +
  facet_wrap(~dir, ncol=1, scales="free_x")+
  ylab("Expression level (Normalised to mean)") +
  xlab("Marker") +
  ggtitle("")

```

The regenerated samples look to be much more variable. 
How does it look on the density plot?


```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

ggplot(manf, aes(x=value, fill=type)) +
  theme_bw() +
  geom_density(alpha=0.5)  +
  scale_fill_manual(values=c("cornflower blue",  "forest green","red3" ), name= "Age") +
  scale_x_continuous(trans='log2', breaks=c(0,0.25,0.5,1,2,4))+
  facet_wrap(~dir, ncol=1  )

````

The wide range and "shoulders" of the regenerated samples in the green may provide support for my previous idea of the "hyper young" and "hyper old"


#Regeneration experiment in detail
This might be clearer if we are comparing the regenerated samples with their controls. 
Only our regen sets: three samples (bef, un, reg) for each pool/individual
##PCA of regeneration sets only

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == "" & sampleinfo$age != "N"

#bcmin <- ctg1to9[,log]
bcmin <- ctg1to9[,c(61:72,85:93, 103:108)]
bcmin <- bcmin[,substr(colnames(bcmin),2, length(colnames(bcmin))) != "reg" ]
bcmin <- bcmin[,c(1:4, 6:18)]

bcmin.groups <- substr(colnames(bcmin),2, length(colnames(bcmin)))
#bcmin<- bcmin[,c(1:5,8:27) ]


bcmin <- subset(bcmin, rownames(bcmin) %in% gm$marker)
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

rg <-ctg1to9[,substr(colnames(ctg1to9),2, length(colnames(ctg1to9))) == "reg" ]
rg <- subset(rg, rownames(rg) %in% gm$marker)
rg.groups <- substr(colnames(rg),2, length(colnames(rg)))

rg.sc <- scale(t(rg), center= bc.pca$center)
rg.pred <- rg.sc %*% bc.pca$rotation 
rgd.pca <- bc.pca
rgd.pca$x <- rbind(bc.pca$x, rg.pred)
                   
rgd.groups <- append(bcmin.groups, rg.groups)           



ggbiplot(rgd.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(rgd.pca$x), groups=rgd.groups)+ggtitle("")+
    theme_bw() +
  scale_colour_manual(values=c("cornflower blue", "forest green", "dark blue"))
```

No clear pattern visible here. 

##Per marker effect 

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
an <- ctg1to9
an <-subset(an, rownames(an) %in% gm$marker)
re <- an[,c(61:72,85:93, 103:108)]
#re <- an[,c(37:48,61:69, 79:84)]
re <- re/rowMeans(re)
msi <- subset(sampleinfo, sampleinfo$sample %in% colnames(re))
re <- re[, msi$qual=="ok"]
                


mre <- melt(re)
mre$sample <- substr(mre$Var2,1,1)
mre$type <- substr(mre$Var2,2,length(mre$Var2))
mre$mk <- substr(mre$Var1, 1,2)
mre$dir <- "upregulated with age"
mre$dir[mre$Var1 %in% gm$marker[gm$dir =="downregulated with age"]] <- "downregulated with age"
mre$md <- paste(substr(mre$dir, 1,2), mre$mk)

ggplot(data=mre, aes(colour=type, x=mk, y=value, fill=dir)) +
  theme_bw() +
  geom_boxplot(outlier.shape=NA) +
  scale_y_continuous(trans='log2', breaks=c(0,0.25,0.5,1,2,4))+
  geom_hline(yintercept=1, colour = "black", linetype=2)+
#  facet_wrap(~sample, ncol=1) +
  scale_color_manual(values=c("cornflower blue", "forest green",  "dark blue")) +
  theme(axis.text.x = element_text(angle = 60, hjust=1))+
  scale_fill_manual(values=c("white", "dark grey")) +
  facet_grid(.~dir,space="free_x",  scales="free_x") +
  xlab("Marker") +
  ylab("Normalised expression")

mre$ms <- substr(mre$md, 1,2)
#ggplot(data=mre, aes(colour=type, x=md, y=value)) +  theme_bw() +  geom_point() +  scale_y_continuous(trans='log2', breaks=c(0,0.25,0.5,1,2,4))+  geom_hline(yintercept=1, colour = "black", linetype=2)+  theme(axis.text.x = element_text(angle = 60, hjust=1))+  facet_wrap(~sample)+  stat_summary(fun.y=mean, geom="point", size=2, shape=18)+  scale_colour_manual(values=c("cornflower blue" , "forest green", "dark blue"), name="Sample Type", labels=c("Before Amputation", "Regenerated","Unamputated"))+  ylab("Expression level (normalised for sample") +  xlab("Marker") +  ggtitle("Effect per marker, per sample")




````

Lets compare the unamputated with the regenerated samples. 

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

an <-subset(an, rownames(an) %in% gm$marker)
re <- an[,c(61:72,85:93, 103:108)]
msi <- subset(sampleinfo, sampleinfo$sample %in% colnames(re))
reg <- re[,msi$qual == "ok"]
rereg <- re[,substr(colnames(re),2,length((colnames(re)))) == "reg"]
reun <- re[,substr(colnames(re),2,length((colnames(re)))) == "un"]
re <- as.data.frame(re)
re$l2fc <-  foldchange2logratio(foldchange(rowMeans(rereg), rowMeans(reun)))
re <- re[order(re$l2fc),]
re$l2fcord <- seq(1, length(re$Abef))

recomp <- cbind(rereg, reun)

re$dir <- subset(gm, gm$dir != "housekeeping")$dir
re$dir <- subset(gm, gm$dir != "housekeeping")$dir
t.result <- apply(recomp, 1, function (x) t.test(x[1:ncol(rereg)],x[ncol(rereg)+1:ncol(recomp)]))
re$p_value <- unlist(lapply(t.result, function(x) x$p.value))
re$t_stat <- unlist(lapply(t.result, function(x) x$statistic))

re$dir <- subset(gm, gm$dir != "housekeeping")$dir
re$marker <- rownames(re)
re$mean <- rowMeans(reg)



mre <- melt(re, id.vars=c("dir", "marker", "mean", "l2fc", "l2fcord", "p_value", "t_stat"))
mre$sample <- substr(mre$variable, 1,1)
mre$type <- substr(mre$variable, 2, length(mre$variable))

cmre <- data.frame(marker = mre$marker[mre$type == "bef"], sample =mre$sample[mre$type == "bef"], dir = mre$dir[mre$type == "bef"],bef= mre$value[mre$type == "bef"], un = mre$value[mre$type == "un"], reg =mre$value[mre$type == "reg"], mean =mre$mean[mre$type == "reg"], l2fc = mre$l2fc[mre$type == "reg"], l2fcord = mre$l2fcord[mre$type == "reg"], p_value=mre$p_value[mre$type == "reg"], t_stat=mre$t_stat[mre$type == "reg"])

cmren <- data.frame(marker = mre$marker[mre$type == "bef"], sample =mre$sample[mre$type == "bef"], dir = mre$dir[mre$type == "bef"], un =cmre$un/cmre$mean, reg =cmre$reg/cmre$mean, l2fc = mre$l2fc[mre$type == "reg"] , l2fcord = cmre$l2fcord, p_value=mre$p_value[mre$type == "reg"], t_stat=mre$t_stat[mre$type == "reg"])


mcmren <- melt(cmren, id.vars=c("marker", "sample", "dir", "l2fc", "l2fcord", "p_value", "t_stat"))
mcmren$md <- paste(substr(mcmren$dir,1,2), substr(mcmren$marker,1,2))

mcmren$ms <- substr(mcmren$marker,1,2)


#mcmren$ms <- factor(mcmren$ms, levels=mcmren$ms[order(mcmren$l2fcord)])



#ggplot(mcmren, aes(x=ms, y=value, colour=variable)) +  theme_bw() +    geom_point(size=2.3, shape=95)  +  geom_boxplot(outlier.shape=NA)+  scale_color_manual(values=c( "dark blue", "forest green"), name="Sample Type", labels=c("Unamputated", "Regenerated"))+  geom_hline(yintercept=1, colour = "black", linetype=2)+  theme(axis.text.x = element_text(angle = 60, hjust=1))+  facet_wrap(~dir, scales="free_x", ncol=1) +  scale_y_continuous(trans='log2', breaks=c(0,0.25,0.5,1,2,4))+  ylab("Expression level (normalised for sample") +  xlab("Marker")+  ggtitle("Effect per marker, normalised to mean for experiment, ordered by reg vs un l2fc")



mcmren$ms <- factor(mcmren$ms, levels=mcmren$ms[order(mcmren$p_value)])
mcmren$unregdir <- sign(mcmren$l2fc)
mcmren$ms <- factor(mcmren$ms, levels=mcmren$ms[order(mcmren$l2fcord)])
mcmren$sig <- mcmren$p_value <0.1

ggplot(mcmren, aes(x=ms, y=value, colour=variable)) +
  theme_bw() +
  geom_point(size=0.3)  +
  geom_boxplot(outlier.shape=NA)+
  scale_color_manual(values=c( "dark blue", "forest green"), name="Sample Type", labels=c("Unamputated", "Regenerated"))+
  geom_hline(yintercept=1, colour = "black", linetype=2)+
  theme(axis.text.x = element_text(angle = 60, hjust=1))+
  scale_y_continuous(trans='log2', breaks=c(0,0.25,0.5,1,2,4))+
  ylab("Expression level (normalised for mean value across experiment)") +
  xlab("Marker")+
  ggtitle("Effect per marker, normalised to mean for experiment, ordered by reg vs un ordered by reg vs un l2fc") +
  theme(plot.title=element_text(size=8,face="bold"))+
  facet_wrap(~dir, scales="free_x", ncol=1) 


ggplot(mcmren, aes(x=ms, y=value, colour=variable)) +
  theme_bw() +
  geom_point(size=2.3, shape=95)  +
  stat_summary(size=0.3)+
  scale_color_manual(values=c( "dark blue", "forest green"), name="Sample Type", labels=c("Unamputated", "Regenerated"))+
  geom_hline(yintercept=1, colour = "black", linetype=2)+
  theme(axis.text.x = element_text(angle = 60, hjust=1))+
  facet_wrap(~dir, scales="free_x", ncol=1) +
  scale_y_continuous(trans='log2', breaks=c(0,0.25,0.5,1,2,4))+
  ylab("Expression level (normalised for mean value across experiment)") +
  xlab("Marker")+
  ggtitle("Effect per marker, normalised to mean for experiment, ordered by reg vs un p-value") +
  theme(plot.title=element_text(size=8,face="bold"))


#t.test(mcmren$value[mcmren$variable== "un"&mcmren$dir=="downregulated with age"], mcmren$value[mcmren$variable== "reg"&mcmren$dir=="downregulated with age"])

````

Marker expression is all over the place after regeneration, not sure what to make of this. Could be that this is the "hyper young and "hyper old" marker response to regeneration?

Could there be a better way of normalising this data? This could help to cut through the noise and reveal our signal. 





##Compare to the regen effect from the previous dataset
Let's add the values for Nikos' regenerated samples (normalised to their unregenerated partners) to this plot and see if they fit with what we find for our new samples. 

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
#log <- 1:ncol(ctg3to9) %in% c(2,5:6, 13:14)
log <- 1:ncol(ctg1to9) %in% c(26, 29:30, 37:38)
ovr <- as.data.frame(ctg1to9[,log==TRUE])
ovrsi <- sampleinfo[log==TRUE,]

ovr$regmean <- rowMeans(data.frame(ovr$OR1a, ovr$OR2a))
ovr$omean <- rowMeans(data.frame(ovr$O2a, ovr$O1b, ovr$O2b))
ovr <- subset(ovr, rownames(ovr) %in% gm$marker)

ovr$regeff <- ovr$regmean/ovr$omean


an <-subset(an, rownames(an) %in% gm$marker)
re <- an[,c(61:72,85:93, 103:108)]
msi <- subset(sampleinfo, sampleinfo$sample %in% colnames(re))
reg <- re[,msi$qual == "ok"]
rereg <- re[,substr(colnames(re),2,length((colnames(re)))) == "reg"]
reun <- re[,substr(colnames(re),2,length((colnames(re)))) == "un"]
re <- as.data.frame(re)
re$l2fc <-  foldchange2logratio(foldchange(rowMeans(rereg), rowMeans(reun)))
re <- re[order(re$l2fc),]
re$l2fcord <- seq(1, length(re$Abef))

recomp <- cbind(rereg, reun)

re$dir <- subset(gm, gm$dir != "housekeeping")$dir
re$dir <- subset(gm, gm$dir != "housekeeping")$dir
t.result <- apply(recomp, 1, function (x) t.test(x[1:ncol(rereg)],x[ncol(rereg)+1:ncol(recomp)]))
re$p_value <- unlist(lapply(t.result, function(x) x$p.value))
re$t_stat <- unlist(lapply(t.result, function(x) x$statistic))

re$dir <- subset(gm, gm$dir != "housekeeping")$dir
re$marker <- rownames(re)
re$mean <- rowMeans(reg)
re$regpval <- ovr$regeff



mre <- melt(re, id.vars=c("dir", "marker", "mean", "l2fc", "l2fcord", "p_value", "t_stat", "regpval"))
mre$sample <- substr(mre$variable, 1,1)
mre$type <- substr(mre$variable, 2, length(mre$variable))

cmre <- data.frame(marker = mre$marker[mre$type == "bef"], sample =mre$sample[mre$type == "bef"], dir = mre$dir[mre$type == "bef"],bef= mre$value[mre$type == "bef"], un = mre$value[mre$type == "un"], reg =mre$value[mre$type == "reg"], mean =mre$mean[mre$type == "reg"], l2fc = mre$l2fc[mre$type == "reg"], l2fcord = mre$l2fcord[mre$type == "reg"], p_value=mre$p_value[mre$type == "reg"], t_stat=mre$t_stat[mre$type == "reg"], regpval=mre$regpval[mre$type == "reg"])

cmren <- data.frame(marker = mre$marker[mre$type == "bef"], sample =mre$sample[mre$type == "bef"], dir = mre$dir[mre$type == "bef"], un =cmre$un/cmre$mean, reg =cmre$reg/cmre$mean, l2fc = mre$l2fc[mre$type == "reg"] , l2fcord = cmre$l2fcord, p_value=mre$p_value[mre$type == "reg"], t_stat=mre$t_stat[mre$type == "reg"], regpval=mre$regpval[mre$type == "reg"])


mcmren <- melt(cmren, id.vars=c("marker", "sample", "dir", "l2fc", "l2fcord", "p_value", "t_stat", "regpval"))
mcmren$md <- paste(substr(mcmren$dir,1,2), substr(mcmren$marker,1,2))

mcmren$ms <- substr(mcmren$marker,1,2)


mcmren$ms <- factor(mcmren$ms, levels=mcmren$ms[order(mcmren$regpval)])


#mcmren$ms <- factor(mcmren$ms, levels=mcmren$ms[order(mcmren$l2fc)])

ggplot(mcmren, aes(x=ms, y=value, colour=variable)) +
  theme_bw() +
  geom_point(size=3, shape=95)  +
  stat_summary(size=0.3)+
  scale_color_manual(values=c( "dark blue", "forest green"), name="Sample Type", labels=c("Unamputated", "Regenerated"))+
  geom_hline(yintercept=1, colour = "black", linetype=2)+
  theme(axis.text.x = element_text(angle = 60, hjust=1))+
  facet_wrap(~dir, scales="free_x", ncol=1) +
  scale_y_continuous(trans='log2', breaks=c(0,0.125,0.25,0.5,1,2,4,8))+
  ylab("Expression level (normalised for sample") +
  xlab("Marker")+
  ggtitle("Effect per marker, normalised to mean for experiment, ordered by reg vs un l2fc") +
  geom_point(inherit.aes=FALSE, aes(x=ms, y=regpval), shape=21, fill="chartreuse3")+
  theme(plot.title=element_text(size=8,face="bold"))


````

The effect in Nikos' dataset doesn't seem to fit very well with what we have here. The important issue to try to get at here, I think is the degree to which each marker's response is stereotyped. Do any makrers respond reliably and stereotypically to regeneration? How best to examine this?

#Moulting effect
What effect does the moulting cycle have? 

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
log <- sampleinfo$moult != ""


bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$moult, log==TRUE)


tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

a=ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+ggtitle("PCA of moulting groups: all 195 markers")+
    theme_bw() +
  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))

log <- sampleinfo$moult != ""


bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$moult, log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in%  gm$marker)


tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups

b= ggbiplot(bc.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE, labels=rownames(tbc), groups=bc.groups)+ggtitle("PCA of moulting groups: 61 chosen markers")+
    theme_bw() +
  scale_colour_manual(values=c("cornflower blue", "red3", "black"))+
  theme(plot.title=element_text(size=8,face="bold"))
multiplot(a,b, cols=2 )

```

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == ""& sampleinfo$age != "N"


bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
bcmin <- subset(bcmin, rownames(bcmin) %in% gm$marker)
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups


log <- sampleinfo$moult != ""
rg <- ctg1to9[,log== TRUE]

rg <- subset(rg, rownames(rg) %in% gm$marker)
rg.groups <- paste(sampleinfo$moult[sampleinfo$sample %in% colnames(rg)], "m")

rg.sc <- scale(t(rg), center= bc.pca$center)
rg.pred <- rg.sc %*% bc.pca$rotation 


rgd.pca <- bc.pca
rgd.pca$x <- rbind(bc.pca$x, rg.pred)
                   
                   
rgd.groups <- append(bcmin.groups, rg.groups)                

a= ggbiplot(rgd.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE,labels = rownames(rgd.pca$x), groups=rgd.groups, varname.abbrev = TRUE)+   
  theme_bw() +
  theme(legend.direction = 'horizontal', legend.position = 'top')+
  ggtitle("PCA Old vs Young + moulting experiment projected: 61 chosen markers")+ 
  scale_colour_manual(values=c("black", "darkgrey", "chocolate4", "cornflower blue", "red3"))+
  theme(plot.title=element_text(size=8,face="bold"))

#####

log <- sampleinfo$sex =="F" & sampleinfo$ctg %in% c(3,4,5,7) & sampleinfo$qual == "ok" & sampleinfo$reg == ""& sampleinfo$age != "N"


bcmin <- ctg1to9[,log== TRUE]
bcmin.groups <- subset(sampleinfo$type, log==TRUE)
tbc <- t(bcmin)
tbc <- tbc[,colSums(tbc) > 0]
bc.pca <- prcomp(tbc,center = TRUE,scale. = TRUE) 
bc.groups <- bcmin.groups


log <- sampleinfo$moult != ""
rg <- ctg1to9[,log== TRUE]

rg.groups <- paste(sampleinfo$moult[sampleinfo$sample %in% colnames(rg)], "m")

rg.sc <- scale(t(rg), center= bc.pca$center)
rg.pred <- rg.sc %*% bc.pca$rotation 


rgd.pca <- bc.pca
rgd.pca$x <- rbind(bc.pca$x, rg.pred)
                   
                   
rgd.groups <- append(bcmin.groups, rg.groups)                

b= ggbiplot(rgd.pca, obs.scale = 1, var.scale = 1, ellipse = FALSE, circle = TRUE, var.axes=FALSE,labels = rownames(rgd.pca$x), groups=rgd.groups, varname.abbrev = TRUE)+   
  theme_bw() +
  theme(legend.direction = 'horizontal', legend.position = 'top')+
  ggtitle("PCA Old vs Young + moulting experiment projected: all 195 markers")+
  scale_colour_manual(values=c("black", "darkgrey", "chocolate4", "cornflower blue", "red3"))+
  theme(plot.title=element_text(size=8,face="bold"))

multiplot(a,b, cols=2 )


````

Seemingly, recently moulted =younger. Response is variable though!